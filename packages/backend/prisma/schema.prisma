generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Location {
  id            Int        @id @default(autoincrement())
  addressLine1  String     @map("address_line1") @db.VarChar(200)
  addressLine2  String?    @map("address_line2") @db.VarChar(200)
  city          String     @db.VarChar(100)
  state         String     @db.VarChar(2)
  zipCode       String     @map("zip_code") @db.VarChar(10)
  providerCount Int?       @default(0) @map("provider_count")
  createdAt     DateTime?  @default(now()) @map("created_at")
  updatedAt     DateTime?  @default(now()) @updatedAt @map("updated_at")
  name          String?    @db.VarChar(200)
  healthSystem  String?    @map("health_system") @db.VarChar(100)
  facilityType  String?    @map("facility_type") @db.VarChar(100)
  providers     Provider[]

  @@unique([addressLine1, city, state, zipCode])
  @@index([state])
  @@index([city, state])
  @@index([zipCode])
  @@map("locations")
}

model Provider {
  npi              String                   @id @db.VarChar(10)
  entityType       String                   @map("entity_type") @db.VarChar(20)
  firstName        String?                  @map("first_name") @db.VarChar(100)
  lastName         String?                  @map("last_name") @db.VarChar(100)
  credential       String?                  @db.VarChar(50)
  organizationName String?                  @map("organization_name") @db.VarChar(200)
  specialty        String?                  @db.VarChar(200)
  specialtyCode    String?                  @map("specialty_code") @db.VarChar(20)
  addressLine1     String                   @map("address_line1") @db.VarChar(200)
  addressLine2     String?                  @map("address_line2") @db.VarChar(200)
  city             String                   @db.VarChar(100)
  state            String                   @db.VarChar(2)
  zipCode          String                   @map("zip_code") @db.VarChar(10)
  phone            String?                  @db.VarChar(20)
  fax              String?                  @db.VarChar(20)
  sex              String?                  @db.VarChar(10)
  enumerationDate  DateTime?                @map("enumeration_date") @db.Date
  lastUpdated      DateTime?                @map("last_updated") @db.Date
  createdAt        DateTime                 @default(now()) @map("created_at")
  id               Int?                     @unique @default(autoincrement())
  locationId       Int?                     @map("location_id")
  healthSystemId   Int?                     @map("health_system_id")
  planAcceptances  ProviderPlanAcceptance[]
  location         Location?                @relation(fields: [locationId], references: [id])
  healthSystem     HealthSystem?            @relation(fields: [healthSystemId], references: [id])
  verificationLogs VerificationLog[]

  @@index([state])
  @@index([specialtyCode])
  @@index([lastName])
  @@index([organizationName])
  @@index([state, specialtyCode])
  @@index([locationId])
  @@index([city])
  @@index([firstName])
  @@index([healthSystemId])
  @@map("providers")
}

model InsurancePlan {
  createdAt           DateTime?                @default(now()) @map("created_at")
  issuerName          String?                  @map("issuer_name") @db.VarChar(200)
  planId              String                   @id @map("plan_id") @db.VarChar(50)
  planName            String?                  @map("plan_name") @db.VarChar(200)
  planType            String?                  @map("plan_type") @db.VarChar(20)
  state               String?                  @db.VarChar(2)

  // Gemini-scraped insurance data fields
  carrier             String?                  @db.VarChar(100)
  planVariant         String?                  @map("plan_variant") @db.VarChar(50)
  rawName             String?                  @map("raw_name") @db.VarChar(500)
  sourceHealthSystem  String?                  @map("source_health_system") @db.VarChar(200)
  providerCount       Int                      @default(0) @map("provider_count")

  // Foreign keys for normalized carrier/health system data
  carrierId           Int?                     @map("carrier_id")
  healthSystemId      Int?                     @map("health_system_id")

  providerAcceptances ProviderPlanAcceptance[]
  verificationLogs    VerificationLog[]
  healthSystemPlans   HealthSystemPlan[]
  carrierRef          Carrier?                 @relation(fields: [carrierId], references: [id])
  healthSystem        HealthSystem?            @relation(fields: [healthSystemId], references: [id])

  @@index([carrier])
  @@index([planVariant])
  @@index([carrierId])
  @@index([healthSystemId])
  @@map("insurance_plans")
}

model ProviderPlanAcceptance {
  id                Int            @id @default(autoincrement())
  providerNpi       String?        @map("npi") @db.VarChar(10)
  planId            String?        @map("plan_id") @db.VarChar(50)
  acceptanceStatus  String         @default("UNKNOWN") @map("acceptance_status") @db.VarChar(20)
  confidenceScore   Int            @default(0) @map("confidence_score")
  lastVerified      DateTime?      @map("last_verified")
  verificationCount Int            @default(0) @map("verification_count")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  expiresAt         DateTime?      @map("expires_at") // TTL: 6 months from last_verified (12% annual provider turnover)
  provider          Provider?      @relation(fields: [providerNpi], references: [npi])
  plan              InsurancePlan? @relation(fields: [planId], references: [planId])

  @@unique([providerNpi, planId])
  @@index([acceptanceStatus])
  @@index([confidenceScore])
  @@index([lastVerified])
  @@index([expiresAt])
  @@map("provider_plan_acceptance")
}

model VerificationLog {
  id                 String             @id @default(cuid())
  providerNpi        String?            @map("provider_npi")
  planId             String?            @map("plan_id")
  acceptanceId       String?
  verificationType   VerificationType
  verificationSource VerificationSource
  previousValue      Json?
  newValue           Json?
  sourceIp           String?            @db.VarChar(50)
  userAgent          String?            @db.VarChar(500)
  submittedBy        String?            @db.VarChar(200)
  upvotes            Int                @default(0)
  downvotes          Int                @default(0)
  isApproved         Boolean?
  reviewedAt         DateTime?
  reviewedBy         String?
  notes              String?
  evidenceUrl        String?            @db.VarChar(500)
  createdAt          DateTime           @default(now()) @map("created_at")
  expiresAt          DateTime?          @map("expires_at") // TTL: 6 months from created_at (12% annual provider turnover)
  plan               InsurancePlan?     @relation(fields: [planId], references: [planId])
  provider           Provider?          @relation(fields: [providerNpi], references: [npi])

  @@index([providerNpi])
  @@index([planId])
  @@index([verificationType])
  @@index([createdAt])
  @@index([isApproved])
  @@index([expiresAt])
  @@index([providerNpi, createdAt])
  @@map("verification_logs")
}

model SyncLog {
  id               Int       @id @default(autoincrement())
  syncType         String?   @map("sync_type") @db.VarChar(50)
  state            String?   @db.VarChar(2)
  recordsProcessed Int?      @default(0) @map("records_processed")
  status           String?   @db.VarChar(20)
  errorMessage     String?   @map("error_message")
  startedAt        DateTime? @default(now()) @map("started_at")
  completedAt      DateTime? @map("completed_at")

  @@map("sync_logs")
}

// ============================================
// Health System Insurance Pipeline Tables
// ============================================

model HealthSystem {
  id               Int                @id @default(autoincrement())
  name             String             @unique @db.VarChar(200)
  website          String?            @db.VarChar(500)
  insurancePageUrl String?            @map("insurance_page_url") @db.VarChar(500)
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  healthSystemPlans HealthSystemPlan[]
  insurancePlans    InsurancePlan[]
  providers         Provider[]

  @@map("health_systems")
}

model CarrierFamily {
  id        Int       @id @default(autoincrement())
  name      String    @unique @db.VarChar(200)
  aliases   String[]  @default([])
  createdAt DateTime  @default(now()) @map("created_at")

  carriers Carrier[]

  @@map("carrier_families")
}

model Carrier {
  id        Int            @id @default(autoincrement())
  familyId  Int?           @map("family_id")
  name      String         @unique @db.VarChar(200)
  states    String[]       @default([])
  website   String?        @db.VarChar(500)
  createdAt DateTime       @default(now()) @map("created_at")

  family         CarrierFamily?  @relation(fields: [familyId], references: [id])
  insurancePlans InsurancePlan[]

  @@index([familyId])
  @@map("carriers")
}

model HealthSystemPlan {
  id             Int           @id @default(autoincrement())
  healthSystemId Int           @map("health_system_id")
  planId         String        @map("plan_id") @db.VarChar(50)
  source         String        @default("SCRAPED") @db.VarChar(20) // SCRAPED, VERIFIED
  scrapedAt      DateTime?     @map("scraped_at")
  createdAt      DateTime      @default(now()) @map("created_at")

  healthSystem HealthSystem  @relation(fields: [healthSystemId], references: [id])
  plan         InsurancePlan @relation(fields: [planId], references: [planId])

  @@unique([healthSystemId, planId])
  @@index([healthSystemId])
  @@index([planId])
  @@map("health_system_plans")
}

enum AcceptanceStatus {
  ACCEPTED
  NOT_ACCEPTED
  PENDING
  UNKNOWN
}

enum VerificationSource {
  CMS_DATA
  CARRIER_DATA
  PROVIDER_PORTAL
  PHONE_CALL
  CROWDSOURCE
  AUTOMATED
}

enum VerificationType {
  PLAN_ACCEPTANCE
  PROVIDER_INFO
  CONTACT_INFO
  STATUS_CHANGE
  NEW_PLAN
}
