generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Provider {
  npi                      String                     @id @db.VarChar(10)
  entityType               String?                    @map("entity_type") @db.VarChar(1)
  lastName                 String?                    @map("last_name") @db.VarChar(100)
  firstName                String?                    @map("first_name") @db.VarChar(100)
  middleName               String?                    @map("middle_name") @db.VarChar(100)
  namePrefix               String?                    @map("name_prefix") @db.VarChar(10)
  nameSuffix               String?                    @map("name_suffix") @db.VarChar(10)
  credential               String?                    @db.VarChar(50)
  organizationName         String?                    @map("organization_name") @db.VarChar(200)
  gender                   String?                    @db.VarChar(1)
  enumerationDate          String?                    @map("enumeration_date") @db.VarChar(10)
  lastUpdateDate           String?                    @map("last_update_date") @db.VarChar(10)
  deactivationDate         String?                    @map("deactivation_date") @db.VarChar(10)
  reactivationDate         String?                    @map("reactivation_date") @db.VarChar(10)
  isSoleProprietor         String?                    @map("is_sole_proprietor") @db.VarChar(1)
  isOrganizationSubpart    String?                    @map("is_organization_subpart") @db.VarChar(1)
  parentOrganizationLbn    String?                    @map("parent_organization_lbn") @db.VarChar(200)
  primaryTaxonomyCode      String?                    @map("primary_taxonomy_code") @db.VarChar(20)
  primarySpecialty          String?                    @map("primary_specialty") @db.VarChar(200)
  specialtyCategory        String?                    @map("specialty_category") @db.VarChar(100)
  nppesLastSynced          DateTime?                  @map("nppes_last_synced") @db.Timestamptz(6)
  practice_locations       practice_locations[]
  provider_cms_details     provider_cms_details?
  provider_hospitals       provider_hospitals[]
  provider_insurance       provider_insurance[]
  provider_medicare        provider_medicare[]
  providerPlanAcceptances  ProviderPlanAcceptance[]
  provider_taxonomies      provider_taxonomies[]
  verificationLogs         VerificationLog[]
  dataQualityAudits        DataQualityAudit[]

  @@index([specialtyCategory], map: "idx_providers_category")
  @@index([credential], map: "idx_providers_credential")
  @@index([gender], map: "idx_providers_gender")
  @@index([lastName], map: "idx_providers_last_name")
  @@index([primarySpecialty], map: "idx_providers_specialty")
  @@index([primaryTaxonomyCode], map: "idx_providers_taxonomy")
  @@map("providers")
}

model hospitals {
  ccn             String  @id @db.VarChar(20)
  hospital_name   String? @db.VarChar(200)
  hospital_system String? @db.VarChar(100)
  address         String? @db.VarChar(200)
  city            String? @db.VarChar(100)
  state           String? @db.VarChar(2)
  zip_code        String? @db.VarChar(10)
  phone           String? @db.VarChar(20)
}

model practice_locations {
  id                      Int                      @id @default(autoincrement())
  npi                     String                   @db.VarChar(10)
  address_type            String?                  @default("practice") @db.VarChar(10)
  address_line1           String?                  @db.VarChar(200)
  address_line2           String?                  @db.VarChar(200)
  city                    String?                  @db.VarChar(100)
  state                   String?                  @db.VarChar(2)
  zip_code                String?                  @db.VarChar(10)
  phone                   String?                  @db.VarChar(20)
  fax                     String?                  @db.VarChar(20)
  address_hash            String?                  @map("address_hash") @db.VarChar(64)
  latitude                Float?
  longitude               Float?
  geocoded_at             DateTime?                @map("geocoded_at") @db.Timestamptz(6)
  providers               Provider                 @relation(fields: [npi], references: [npi], onDelete: NoAction, onUpdate: NoAction)
  providerPlanAcceptances ProviderPlanAcceptance[]

  @@index([city], map: "idx_locations_city")
  @@index([npi], map: "idx_locations_npi")
  @@index([state], map: "idx_locations_state")
  @@index([zip_code], map: "idx_locations_zip")
  @@index([address_hash], map: "idx_locations_address_hash")
  @@index([latitude, longitude], map: "idx_locations_lat_lng")
  @@index([geocoded_at], map: "idx_locations_geocoded_at")
}

model provider_cms_details {
  npi                 String   @id @db.VarChar(10)
  group_practice_name String?  @db.VarChar(200)
  medical_school      String?  @db.VarChar(200)
  graduation_year     String?  @db.VarChar(4)
  medicare_assignment String?  @db.VarChar(1)
  telehealth          String?  @db.VarChar(1)
  source              String?  @default("cms_national") @db.VarChar(30)
  providers           Provider @relation(fields: [npi], references: [npi], onDelete: NoAction, onUpdate: NoAction)
}

model provider_hospitals {
  id              Int      @id @default(autoincrement())
  npi             String   @db.VarChar(10)
  hospital_system String?  @db.VarChar(100)
  hospital_name   String?  @db.VarChar(200)
  ccn             String?  @db.VarChar(20)
  source          String?  @db.VarChar(30)
  confidence      String?  @default("MEDIUM") @db.VarChar(10)
  providers       Provider @relation(fields: [npi], references: [npi], onDelete: NoAction, onUpdate: NoAction)

  @@index([npi], map: "idx_hospitals_npi")
  @@index([hospital_system], map: "idx_hospitals_system")
}

model provider_insurance {
  id            Int      @id @default(autoincrement())
  npi           String   @db.VarChar(10)
  network_name  String?  @db.VarChar(200)
  identifier_id String?  @db.VarChar(100)
  source        String?  @default("npi_other_id") @db.VarChar(30)
  confidence    String?  @default("MEDIUM") @db.VarChar(10)
  providers     Provider @relation(fields: [npi], references: [npi], onDelete: NoAction, onUpdate: NoAction)

  @@index([network_name], map: "idx_insurance_network")
  @@index([npi], map: "idx_insurance_npi")
}

model provider_medicare {
  id             Int      @id @default(autoincrement())
  npi            String   @db.VarChar(10)
  medicare_id    String?  @db.VarChar(20)
  medicare_state String?  @db.VarChar(2)
  source         String?  @default("npi_other_id") @db.VarChar(30)
  providers      Provider @relation(fields: [npi], references: [npi], onDelete: NoAction, onUpdate: NoAction)

  @@index([npi], map: "idx_medicare_npi")
}

model provider_taxonomies {
  id            Int      @id @default(autoincrement())
  npi           String   @db.VarChar(10)
  taxonomy_code String?  @db.VarChar(20)
  is_primary    String?  @db.VarChar(1)
  slot_number   Int?
  providers     Provider @relation(fields: [npi], references: [npi], onDelete: NoAction, onUpdate: NoAction)

  @@index([taxonomy_code], map: "idx_taxonomies_code")
  @@index([npi], map: "idx_taxonomies_npi")
}

model taxonomy_reference {
  taxonomy_code     String  @id @db.VarChar(20)
  display_name      String? @db.VarChar(200)
  grouping_name     String? @db.VarChar(200)
  classification    String? @db.VarChar(200)
  specialization    String? @db.VarChar(200)
  standardized_name String? @db.VarChar(200)
  provider_count    Int?
}

model InsurancePlan {
  planId              String                     @id @map("plan_id") @db.VarChar(50)
  planName            String?                    @map("plan_name") @db.VarChar(200)
  issuerName          String?                    @map("issuer_name") @db.VarChar(200)
  planType            String?                    @map("plan_type") @db.VarChar(20)
  state               String?                    @db.VarChar(2)
  carrier             String?                    @db.VarChar(100)
  planVariant         String?                    @map("plan_variant") @db.VarChar(50)
  rawName             String?                    @map("raw_name") @db.VarChar(500)
  sourceHealthSystem  String?                    @map("source_health_system") @db.VarChar(200)
  providerCount       Int                        @default(0) @map("provider_count")
  carrierId           Int?                       @map("carrier_id")
  healthSystemId      Int?                       @map("health_system_id")
  createdAt           DateTime?                  @default(now()) @map("created_at") @db.Timestamptz(6)
  providerAcceptances ProviderPlanAcceptance[]
  verificationLogs    VerificationLog[]

  @@index([carrier], map: "idx_insurance_plans_carrier")
  @@index([carrierId], map: "idx_insurance_plans_carrier_id")
  @@index([healthSystemId], map: "idx_insurance_plans_health_system_id")
  @@index([planVariant], map: "idx_insurance_plans_plan_variant")
  @@map("insurance_plans")
}

model ProviderPlanAcceptance {
  id                 Int                @id @default(autoincrement())
  providerNpi        String?            @map("npi") @db.VarChar(10)
  planId             String?            @map("plan_id") @db.VarChar(50)
  locationId         Int?               @map("location_id")
  acceptanceStatus   String             @default("UNKNOWN") @map("acceptance_status") @db.VarChar(20)
  confidenceScore    Int                @default(0) @map("confidence_score")
  lastVerified       DateTime?          @map("last_verified") @db.Timestamptz(6)
  verificationCount  Int                @default(0) @map("verification_count")
  createdAt          DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime           @default(now()) @map("updated_at") @db.Timestamptz(6)
  expiresAt          DateTime?          @map("expires_at") @db.Timestamptz(6)
  provider           Provider?          @relation(fields: [providerNpi], references: [npi], onUpdate: NoAction)
  insurancePlan      InsurancePlan?     @relation(fields: [planId], references: [planId], onUpdate: NoAction)
  location           practice_locations? @relation(fields: [locationId], references: [id], onUpdate: NoAction)

  // Unique constraints managed via raw SQL partial indexes:
  // idx_ppa_npi_plan_location: UNIQUE(npi, plan_id, location_id) WHERE location_id IS NOT NULL
  // idx_ppa_npi_plan_legacy: UNIQUE(npi, plan_id) WHERE location_id IS NULL
  @@index([acceptanceStatus], map: "idx_ppa_acceptance_status")
  @@index([confidenceScore], map: "idx_ppa_confidence_score")
  @@index([expiresAt], map: "idx_ppa_expires_at")
  @@index([lastVerified], map: "idx_ppa_last_verified")
  @@index([locationId], map: "idx_ppa_location_id")
  @@map("provider_plan_acceptance")
}

model VerificationLog {
  id                 String             @id @default(cuid())
  providerNpi        String?            @map("provider_npi") @db.VarChar(10)
  planId             String?            @map("plan_id") @db.VarChar(50)
  acceptanceId       String?
  verificationType   VerificationType
  verificationSource VerificationSource
  previousValue      Json?
  newValue           Json?
  sourceIp           String?            @db.VarChar(50)
  userAgent          String?            @db.VarChar(500)
  submittedBy        String?            @db.VarChar(200)
  upvotes            Int                @default(0)
  downvotes          Int                @default(0)
  isApproved         Boolean?
  reviewedAt         DateTime?          @db.Timestamptz(6)
  reviewedBy         String?
  notes              String?
  evidenceUrl        String?            @db.VarChar(500)
  createdAt          DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt          DateTime?          @map("expires_at") @db.Timestamptz(6)
  plan               InsurancePlan?     @relation(fields: [planId], references: [planId], onUpdate: NoAction)
  provider           Provider?          @relation(fields: [providerNpi], references: [npi], onUpdate: NoAction)
  votes              VoteLog[]

  @@index([createdAt], map: "idx_vl_created_at")
  @@index([expiresAt], map: "idx_vl_expires_at")
  @@index([isApproved], map: "idx_vl_is_approved")
  @@index([planId], map: "idx_vl_plan_id")
  @@index([providerNpi, createdAt], map: "idx_vl_provider_created")
  @@index([providerNpi], map: "idx_vl_provider_npi")
  @@index([providerNpi, planId, submittedBy, createdAt], map: "idx_vl_sybil_email")
  @@index([providerNpi, planId, sourceIp, createdAt], map: "idx_vl_sybil_ip")
  @@index([verificationType], map: "idx_vl_verification_type")
  @@map("verification_logs")
}

model VoteLog {
  id               String           @id @default(cuid())
  verificationId   String           @map("verification_id")
  sourceIp         String           @map("source_ip") @db.VarChar(50)
  vote             String           @db.VarChar(10)
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  verification     VerificationLog  @relation(fields: [verificationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([verificationId, sourceIp])
  @@index([sourceIp], map: "idx_vote_logs_source_ip")
  @@index([verificationId], map: "idx_vote_logs_verification_id")
  @@map("vote_logs")
}

model SyncLog {
  id                Int       @id @default(autoincrement())
  syncType          String?   @map("sync_type") @db.VarChar(50)
  state             String?   @db.VarChar(2)
  recordsProcessed  Int?      @default(0) @map("records_processed")
  status            String?   @db.VarChar(20)
  errorMessage      String?   @map("error_message")
  startedAt         DateTime? @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt       DateTime? @map("completed_at") @db.Timestamptz(6)

  @@map("sync_logs")
}

model DataQualityAudit {
  id             Int       @id @default(autoincrement())
  npi            String    @db.VarChar(10)
  auditType      String    @map("audit_type") @db.VarChar(50)
  severity       String    @db.VarChar(20)
  field          String?   @db.VarChar(100)
  currentValue   String?   @map("current_value")
  expectedValue  String?   @map("expected_value")
  details        String?
  resolved       Boolean   @default(false)
  resolvedAt     DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  provider       Provider  @relation(fields: [npi], references: [npi], onDelete: NoAction, onUpdate: NoAction)

  @@index([npi], map: "idx_dqa_npi")
  @@index([severity], map: "idx_dqa_severity")
  @@index([auditType], map: "idx_dqa_audit_type")
  @@index([resolved], map: "idx_dqa_resolved")
  @@map("data_quality_audit")
}

enum AcceptanceStatus {
  ACCEPTED
  NOT_ACCEPTED
  PENDING
  UNKNOWN
}

enum VerificationSource {
  CMS_DATA
  CARRIER_DATA
  PROVIDER_PORTAL
  PHONE_CALL
  CROWDSOURCE
  AUTOMATED
  NPPES_SYNC
  CARRIER_SCRAPE
  NETWORK_CROSSREF
}

enum VerificationType {
  PLAN_ACCEPTANCE
  PROVIDER_INFO
  CONTACT_INFO
  STATUS_CHANGE
  NEW_PLAN
}
