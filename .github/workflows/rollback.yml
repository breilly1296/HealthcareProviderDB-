name: Rollback Cloud Run Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to roll back'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
      revision:
        description: 'Specific revision name (leave empty to roll back to previous revision)'
        required: false
        type: string

env:
  GCP_REGION: us-central1

jobs:
  rollback-backend:
    name: Rollback Backend
    if: ${{ inputs.service == 'backend' || inputs.service == 'both' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: List recent backend revisions
        run: |
          echo "## Recent Backend Revisions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          gcloud run revisions list \
            --service=verifymyprovider-backend \
            --region=${{ env.GCP_REGION }} \
            --limit=5 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Determine target revision
        id: target
        run: |
          if [ -n "${{ inputs.revision }}" ]; then
            echo "revision=${{ inputs.revision }}" >> $GITHUB_OUTPUT
            echo "Rolling back to specified revision: ${{ inputs.revision }}"
          else
            PREVIOUS=$(gcloud run revisions list \
              --service=verifymyprovider-backend \
              --region=${{ env.GCP_REGION }} \
              --limit=2 \
              --format='value(REVISION)' | tail -n 1)
            if [ -z "$PREVIOUS" ]; then
              echo "No previous revision found"
              exit 1
            fi
            echo "revision=$PREVIOUS" >> $GITHUB_OUTPUT
            echo "Rolling back to previous revision: $PREVIOUS"
          fi

      - name: Route traffic to target revision
        run: |
          gcloud run services update-traffic verifymyprovider-backend \
            --region=${{ env.GCP_REGION }} \
            --to-revisions=${{ steps.target.outputs.revision }}=100
          echo "Backend rolled back to revision: ${{ steps.target.outputs.revision }}"

      - name: Smoke test backend
        run: |
          sleep 10
          BACKEND_URL=$(gcloud run services describe verifymyprovider-backend \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Backend smoke test failed with status $HTTP_STATUS"
            exit 1
          fi
          echo "Backend smoke test passed (HTTP $HTTP_STATUS)"

      - name: Rollback summary
        run: |
          echo "## Backend Rollback Result" >> $GITHUB_STEP_SUMMARY
          echo "Rolled back **verifymyprovider-backend** to revision \`${{ steps.target.outputs.revision }}\`" >> $GITHUB_STEP_SUMMARY

  rollback-frontend:
    name: Rollback Frontend
    if: ${{ inputs.service == 'frontend' || inputs.service == 'both' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: List recent frontend revisions
        run: |
          echo "## Recent Frontend Revisions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          gcloud run revisions list \
            --service=verifymyprovider-frontend \
            --region=${{ env.GCP_REGION }} \
            --limit=5 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Determine target revision
        id: target
        run: |
          if [ -n "${{ inputs.revision }}" ]; then
            echo "revision=${{ inputs.revision }}" >> $GITHUB_OUTPUT
            echo "Rolling back to specified revision: ${{ inputs.revision }}"
          else
            PREVIOUS=$(gcloud run revisions list \
              --service=verifymyprovider-frontend \
              --region=${{ env.GCP_REGION }} \
              --limit=2 \
              --format='value(REVISION)' | tail -n 1)
            if [ -z "$PREVIOUS" ]; then
              echo "No previous revision found"
              exit 1
            fi
            echo "revision=$PREVIOUS" >> $GITHUB_OUTPUT
            echo "Rolling back to previous revision: $PREVIOUS"
          fi

      - name: Route traffic to target revision
        run: |
          gcloud run services update-traffic verifymyprovider-frontend \
            --region=${{ env.GCP_REGION }} \
            --to-revisions=${{ steps.target.outputs.revision }}=100
          echo "Frontend rolled back to revision: ${{ steps.target.outputs.revision }}"

      - name: Smoke test frontend
        run: |
          sleep 10
          FRONTEND_URL=$(gcloud run services describe verifymyprovider-frontend \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Frontend smoke test failed with status $HTTP_STATUS"
            exit 1
          fi
          echo "Frontend smoke test passed (HTTP $HTTP_STATUS)"

      - name: Rollback summary
        run: |
          echo "## Frontend Rollback Result" >> $GITHUB_STEP_SUMMARY
          echo "Rolled back **verifymyprovider-frontend** to revision \`${{ steps.target.outputs.revision }}\`" >> $GITHUB_STEP_SUMMARY
