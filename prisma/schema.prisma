generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Healthcare providers from NPI registry
model Provider {
  id                    String   @id @default(cuid())
  npi                   String   @unique @db.VarChar(10)
  entityType            EntityType

  // Individual provider fields
  firstName             String?  @db.VarChar(100)
  lastName              String?  @db.VarChar(100)
  middleName            String?  @db.VarChar(100)
  credential            String?  @db.VarChar(50)

  // Organization fields
  organizationName      String?  @db.VarChar(300)

  // Primary practice address
  addressLine1          String   @db.VarChar(200)
  addressLine2          String?  @db.VarChar(200)
  city                  String   @db.VarChar(100)
  state                 String   @db.VarChar(2)
  zip                   String   @db.VarChar(10)
  country               String   @default("US") @db.VarChar(2)

  // Contact
  phone                 String?  @db.VarChar(20)
  fax                   String?  @db.VarChar(20)

  // Taxonomy/Specialty (primary)
  taxonomyCode          String?  @db.VarChar(20)
  taxonomyDescription   String?  @db.VarChar(200)
  specialtyCategory     SpecialtyCategory?

  // Secondary taxonomies stored as JSON array
  secondaryTaxonomies   Json?

  // NPI metadata
  enumerationDate       DateTime?
  lastUpdateDate        DateTime?
  deactivationDate      DateTime?
  reactivationDate      DateTime?
  npiStatus             NpiStatus @default(ACTIVE)

  // Internal tracking
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  planAcceptances       ProviderPlanAcceptance[]
  verificationLogs      VerificationLog[]

  @@index([state])
  @@index([taxonomyCode])
  @@index([specialtyCategory])
  @@index([lastName])
  @@index([organizationName])
  @@index([state, specialtyCategory])

  @@map("providers")
}

// Insurance plans from CMS and user uploads
model InsurancePlan {
  id                    String   @id @default(cuid())

  // Plan identification
  planId                String   @unique @db.VarChar(50)  // CMS plan ID or internal ID
  planName              String   @db.VarChar(300)

  // Carrier/Issuer info
  carrierId             String?  @db.VarChar(50)
  carrierName           String   @db.VarChar(200)

  // Plan details
  planType              PlanType
  metalLevel            MetalLevel?
  marketType            MarketType

  // Coverage area
  statesCovered         String[] // Array of state codes
  serviceArea           String?  @db.VarChar(500)

  // Plan year
  planYear              Int
  effectiveDate         DateTime?
  terminationDate       DateTime?

  // Data source
  dataSource            DataSource
  sourceFileId          String?

  // Status
  isActive              Boolean  @default(true)

  // Internal tracking
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  providerAcceptances   ProviderPlanAcceptance[]
  verificationLogs      VerificationLog[]

  @@index([carrierName])
  @@index([planType])
  @@index([statesCovered])
  @@index([planYear])
  @@index([isActive])

  @@map("insurance_plans")
}

// Provider-Plan acceptance matching table
model ProviderPlanAcceptance {
  id                    String   @id @default(cuid())

  providerId            String
  provider              Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  planId                String
  plan                  InsurancePlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Acceptance status
  acceptanceStatus      AcceptanceStatus @default(UNKNOWN)
  acceptsNewPatients    Boolean?

  // Confidence scoring
  confidenceScore       Float    @default(0) // 0-100 scale
  confidenceFactors     Json?    // Breakdown of scoring factors

  // Verification
  lastVerifiedAt        DateTime?
  verificationSource    VerificationSource?
  verificationCount     Int      @default(0)

  // Effective dates
  effectiveDate         DateTime?
  terminationDate       DateTime?

  // Internal tracking
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([providerId, planId])
  @@index([acceptanceStatus])
  @@index([confidenceScore])
  @@index([lastVerifiedAt])

  @@map("provider_plan_acceptance")
}

// Verification audit trail
model VerificationLog {
  id                    String   @id @default(cuid())

  // What was verified
  providerId            String?
  provider              Provider? @relation(fields: [providerId], references: [id], onDelete: SetNull)

  planId                String?
  plan                  InsurancePlan? @relation(fields: [planId], references: [id], onDelete: SetNull)

  acceptanceId          String?

  // Verification details
  verificationType      VerificationType
  verificationSource    VerificationSource

  // Before/after state
  previousValue         Json?
  newValue              Json?

  // Source information
  sourceIp              String?  @db.VarChar(50)
  userAgent             String?  @db.VarChar(500)
  submittedBy           String?  @db.VarChar(200) // Email or anonymous ID

  // Crowdsource specific
  upvotes               Int      @default(0)
  downvotes             Int      @default(0)
  isApproved            Boolean?
  reviewedAt            DateTime?
  reviewedBy            String?

  // Additional context
  notes                 String?
  evidenceUrl           String?  @db.VarChar(500)

  createdAt             DateTime @default(now())

  @@index([providerId])
  @@index([planId])
  @@index([verificationType])
  @@index([createdAt])
  @@index([isApproved])

  @@map("verification_logs")
}

// Sync/Import log for tracking data imports
model SyncLog {
  id                    String   @id @default(cuid())

  // Sync identification
  syncType              SyncType
  dataSource            DataSource

  // File information
  sourceFileName        String?  @db.VarChar(500)
  sourceFileHash        String?  @db.VarChar(64)  // SHA-256
  sourceFileSize        BigInt?
  sourceFileDate        DateTime?

  // Sync status
  status                SyncStatus
  startedAt             DateTime @default(now())
  completedAt           DateTime?

  // Statistics
  totalRecords          Int      @default(0)
  processedRecords      Int      @default(0)
  insertedRecords       Int      @default(0)
  updatedRecords        Int      @default(0)
  skippedRecords        Int      @default(0)
  errorRecords          Int      @default(0)

  // Error tracking
  errorLog              Json?    // Array of error details
  lastError             String?

  // Filter criteria used
  filterCriteria        Json?    // e.g., { states: ["FL"], specialties: ["rheumatology"] }

  // Metadata
  triggeredBy           String?  @db.VarChar(200)
  notes                 String?

  @@index([syncType])
  @@index([dataSource])
  @@index([status])
  @@index([startedAt])

  @@map("sync_logs")
}

// Enums

enum EntityType {
  INDIVIDUAL  // NPI-1
  ORGANIZATION // NPI-2
}

enum SpecialtyCategory {
  // Original categories
  ENDOCRINOLOGY
  RHEUMATOLOGY
  ORTHOPEDICS
  INTERNAL_MEDICINE
  FAMILY_MEDICINE
  GERIATRICS

  // Mental Health & Behavioral
  MENTAL_HEALTH
  PSYCHIATRY
  PSYCHOLOGY
  SOCIAL_WORK

  // Nursing & Advanced Practice
  NURSING
  NURSE_PRACTITIONER
  PHYSICIAN_ASSISTANT
  MIDWIFERY

  // Dental & Vision
  DENTISTRY
  OPTOMETRY

  // Pharmacy
  PHARMACY

  // Therapy & Rehabilitation
  PHYSICAL_THERAPY
  OCCUPATIONAL_THERAPY
  SPEECH_THERAPY
  RESPIRATORY_THERAPY
  CHIROPRACTIC
  ACUPUNCTURE

  // Medical Specialties
  EMERGENCY_MEDICINE
  PEDIATRICS
  ANESTHESIOLOGY
  SURGERY
  OB_GYN
  CARDIOLOGY
  RADIOLOGY
  DERMATOLOGY
  NEUROLOGY
  ONCOLOGY
  UROLOGY
  GASTROENTEROLOGY
  PULMONOLOGY
  NEPHROLOGY
  INFECTIOUS_DISEASE
  ALLERGY_IMMUNOLOGY
  PATHOLOGY

  // Support Services
  DIETETICS
  LAB_PATHOLOGY
  DME_PROSTHETICS
  COMMUNITY_HEALTH
  HOME_HEALTH
  HOSPICE_PALLIATIVE

  // Facilities
  CLINIC_FACILITY
  HOSPITAL

  // Catch-all
  OTHER
}

enum NpiStatus {
  ACTIVE
  DEACTIVATED
}

enum PlanType {
  HMO
  PPO
  EPO
  POS
  HDHP
  MEDICARE_ADVANTAGE
  MEDICAID
  OTHER
}

enum MetalLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  CATASTROPHIC
}

enum MarketType {
  INDIVIDUAL
  SMALL_GROUP
  LARGE_GROUP
  MEDICARE
  MEDICAID
}

enum DataSource {
  CMS_NPPES       // NPI registry
  CMS_PLAN_FINDER // CMS plan data
  USER_UPLOAD     // Manual upload
  CARRIER_API     // Direct from insurance carrier
  CROWDSOURCE     // User-submitted
}

enum AcceptanceStatus {
  ACCEPTED        // Provider accepts this plan
  NOT_ACCEPTED    // Provider does not accept
  PENDING         // Awaiting verification
  UNKNOWN         // No data
}

enum VerificationSource {
  CMS_DATA        // Official CMS data
  CARRIER_DATA    // Insurance carrier data
  PROVIDER_PORTAL // Provider's own website/portal
  PHONE_CALL      // Phone verification
  CROWDSOURCE     // User submission
  AUTOMATED       // System-generated
}

enum VerificationType {
  PLAN_ACCEPTANCE     // Verifying plan acceptance
  PROVIDER_INFO       // Verifying provider details
  CONTACT_INFO        // Verifying contact information
  STATUS_CHANGE       // Provider status change
  NEW_PLAN            // New plan added
}

enum SyncType {
  NPI_FULL        // Full NPI data sync
  NPI_WEEKLY      // Weekly NPI updates
  PLAN_IMPORT     // Insurance plan import
  PLAN_UPDATE     // Plan data update
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}
