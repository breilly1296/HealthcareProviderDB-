generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Physical locations (hospitals, offices, clinics)
// Groups providers by shared address
model Location {
  id            Int       @id @default(autoincrement())
  addressLine1  String    @map("address_line1") @db.VarChar(200)
  addressLine2  String?   @map("address_line2") @db.VarChar(200)
  city          String    @db.VarChar(100)
  state         String    @db.VarChar(2)
  zipCode       String    @map("zip_code") @db.VarChar(10)
  providerCount Int?      @default(0) @map("provider_count")
  createdAt     DateTime? @default(now()) @map("created_at")
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at")
  name          String?   @db.VarChar(200)
  healthSystem  String?   @map("health_system") @db.VarChar(100)
  facilityType  String?   @map("facility_type") @db.VarChar(100)

  providers     Provider[]

  @@unique([addressLine1, city, state, zipCode])
  @@index([state])
  @@index([city, state])
  @@index([zipCode])

  @@map("locations")
}

// Healthcare providers from NPI registry
model Provider {
  // Primary Key
  npi                   String    @id @db.VarChar(10)

  // Auto-increment ID (exists in DB but not used as primary key)
  id                    Int?      @unique @default(autoincrement())

  // Entity type
  entityType            String    @db.VarChar(20) @map("entity_type")

  // Individual provider fields
  firstName             String?   @db.VarChar(100) @map("first_name")
  lastName              String?   @db.VarChar(100) @map("last_name")
  credential            String?   @db.VarChar(50)
  sex                   String?   @db.VarChar(10)

  // Organization fields
  organizationName      String?   @db.VarChar(200) @map("organization_name")

  // Specialty/Taxonomy
  specialty             String?   @db.VarChar(200)
  specialtyCode         String?   @db.VarChar(20) @map("specialty_code")

  // Primary practice address
  addressLine1          String    @db.VarChar(200) @map("address_line1")
  addressLine2          String?   @db.VarChar(200) @map("address_line2")
  city                  String    @db.VarChar(100)
  state                 String    @db.VarChar(2)
  zipCode               String    @db.VarChar(10) @map("zip_code")

  // Contact
  phone                 String?   @db.VarChar(20)
  fax                   String?   @db.VarChar(20)

  // NPI metadata
  enumerationDate       DateTime? @db.Date @map("enumeration_date")
  lastUpdated           DateTime? @db.Date @map("last_updated")

  // Internal tracking
  createdAt             DateTime  @default(now()) @map("created_at")

  // Location relationship
  locationId            Int?      @map("location_id")
  location              Location? @relation(fields: [locationId], references: [id])

  // Relations
  planAcceptances       ProviderPlanAcceptance[]
  verificationLogs      VerificationLog[]

  @@index([state])
  @@index([specialtyCode])
  @@index([lastName])
  @@index([firstName])        // For name searches
  @@index([city])             // For location filtering
  @@index([organizationName])
  @@index([state, specialtyCode])
  @@index([locationId])

  @@map("providers")
}

// Insurance plans from CMS and user uploads
model InsurancePlan {
  planId      String    @id @map("plan_id") @db.VarChar(50)
  planName    String?   @map("plan_name") @db.VarChar(200)
  issuerName  String?   @map("issuer_name") @db.VarChar(200)
  planType    String?   @map("plan_type") @db.VarChar(20)
  state       String?   @db.VarChar(2)
  createdAt   DateTime? @default(now()) @map("created_at")

  // Relations
  providerAcceptances   ProviderPlanAcceptance[]
  verificationLogs      VerificationLog[]

  @@map("insurance_plans")
}

// Provider-Plan acceptance matching table
// Note: Using SetNull instead of Cascade to preserve audit trail when provider/plan is deleted
model ProviderPlanAcceptance {
  id                    Int      @id @default(autoincrement())

  providerNpi           String?  @db.VarChar(10) @map("npi")
  provider              Provider? @relation(fields: [providerNpi], references: [npi], onDelete: SetNull)

  planId                String?  @db.VarChar(50) @map("plan_id")
  plan                  InsurancePlan? @relation(fields: [planId], references: [planId], onDelete: SetNull)

  // Acceptance status
  acceptanceStatus      String   @default("UNKNOWN") @db.VarChar(20) @map("acceptance_status")

  // Confidence scoring
  confidenceScore       Int      @default(0) @map("confidence_score")

  // Verification
  lastVerified          DateTime? @map("last_verified")
  verificationCount     Int      @default(0) @map("verification_count")

  // Internal tracking
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // TTL: 6 months from last_verified (based on 12% annual provider turnover)
  expiresAt             DateTime? @map("expires_at")

  @@unique([providerNpi, planId])
  @@index([acceptanceStatus])
  @@index([confidenceScore])
  @@index([lastVerified])
  @@index([expiresAt])

  @@map("provider_plan_acceptance")
}

// Verification audit trail
model VerificationLog {
  id                    String   @id @default(cuid())

  // What was verified
  providerNpi           String?  @map("provider_npi")
  provider              Provider? @relation(fields: [providerNpi], references: [npi], onDelete: SetNull)

  planId                String?  @map("plan_id")
  plan                  InsurancePlan? @relation(fields: [planId], references: [planId], onDelete: SetNull)

  acceptanceId          String?

  // Verification details
  verificationType      VerificationType
  verificationSource    VerificationSource

  // Before/after state
  previousValue         Json?
  newValue              Json?

  // Source information
  sourceIp              String?  @db.VarChar(50)
  userAgent             String?  @db.VarChar(500)
  submittedBy           String?  @db.VarChar(200) // Email or anonymous ID

  // Crowdsource specific
  upvotes               Int      @default(0)
  downvotes             Int      @default(0)
  isApproved            Boolean?
  reviewedAt            DateTime?
  reviewedBy            String?

  // Additional context
  notes                 String?
  evidenceUrl           String?  @db.VarChar(500)

  createdAt             DateTime @default(now()) @map("created_at")

  // TTL: 6 months from created_at (based on 12% annual provider turnover)
  expiresAt             DateTime? @map("expires_at")

  // Vote deduplication
  votes                 VoteLog[]

  @@index([providerNpi])
  @@index([planId])
  @@index([verificationType])
  @@index([createdAt])
  @@index([isApproved])
  @@index([expiresAt])
  @@index([providerNpi, createdAt])
  @@index([providerNpi, planId, sourceIp, createdAt])    // Sybil attack prevention
  @@index([providerNpi, planId, submittedBy, createdAt]) // Sybil attack prevention

  @@map("verification_logs")
}

// Vote deduplication - prevents unlimited voting from same IP
model VoteLog {
  id             String   @id @default(cuid())
  verificationId String   @map("verification_id")
  sourceIp       String   @map("source_ip") @db.VarChar(50)
  vote           String   @db.VarChar(10) // 'up' or 'down'
  createdAt      DateTime @default(now()) @map("created_at")

  verification   VerificationLog @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@unique([verificationId, sourceIp]) // One vote per IP per verification
  @@index([verificationId])
  @@index([sourceIp])
  @@map("vote_logs")
}

// Sync/Import log for tracking data imports
model SyncLog {
  id               Int       @id @default(autoincrement())
  syncType         String?   @map("sync_type") @db.VarChar(50)
  state            String?   @db.VarChar(2)
  recordsProcessed Int?      @default(0) @map("records_processed")
  status           String?   @db.VarChar(20)
  errorMessage     String?   @map("error_message")
  startedAt        DateTime? @default(now()) @map("started_at")
  completedAt      DateTime? @map("completed_at")

  @@map("sync_logs")
}

// Enums

// EntityType enum removed - using String instead since DB column is VARCHAR(20)
// Values should be: "INDIVIDUAL" or "ORGANIZATION"

// COMMENTED OUT - Changed to VARCHAR(200) for flexibility
// Uncomment this enum to rollback the migration
// enum EntityType {
//   INDIVIDUAL  // NPI-1
//   ORGANIZATION // NPI-2
// }
//
// enum SpecialtyCategory {
//   // Original categories
//   ENDOCRINOLOGY
//   RHEUMATOLOGY
//   ORTHOPEDICS
//   INTERNAL_MEDICINE
//   FAMILY_MEDICINE
//   GERIATRICS
//
//   // Mental Health & Behavioral
//   MENTAL_HEALTH
//   PSYCHIATRY
//   PSYCHOLOGY
//   SOCIAL_WORK
//
//   // Nursing & Advanced Practice
//   NURSING
//   NURSE_PRACTITIONER
//   PHYSICIAN_ASSISTANT
//   MIDWIFERY
//
//   // Dental & Vision
//   DENTISTRY
//   OPTOMETRY
//
//   // Pharmacy
//   PHARMACY
//
//   // Therapy & Rehabilitation
//   PHYSICAL_THERAPY
//   OCCUPATIONAL_THERAPY
//   SPEECH_THERAPY
//   RESPIRATORY_THERAPY
//   CHIROPRACTIC
//   ACUPUNCTURE
//
//   // Medical Specialties
//   EMERGENCY_MEDICINE
//   PEDIATRICS
//   ANESTHESIOLOGY
//   SURGERY
//   OB_GYN
//   CARDIOLOGY
//   RADIOLOGY
//   DERMATOLOGY
//   NEUROLOGY
//   ONCOLOGY
//   UROLOGY
//   GASTROENTEROLOGY
//   PULMONOLOGY
//   NEPHROLOGY
//   INFECTIOUS_DISEASE
//   ALLERGY_IMMUNOLOGY
//   PATHOLOGY
//
//   // Support Services
//   DIETETICS
//   LAB_PATHOLOGY
//   DME_PROSTHETICS
//   COMMUNITY_HEALTH
//   HOME_HEALTH
//   HOSPICE_PALLIATIVE
//
//   // Facilities
//   CLINIC_FACILITY
//   HOSPITAL
//
//   // Catch-all
//   OTHER
// }
//
// enum NpiStatus {
//   ACTIVE
//   DEACTIVATED
// }

enum AcceptanceStatus {
  ACCEPTED        // Provider accepts this plan
  NOT_ACCEPTED    // Provider does not accept
  PENDING         // Awaiting verification
  UNKNOWN         // No data
}

enum VerificationSource {
  CMS_DATA        // Official CMS data
  CARRIER_DATA    // Insurance carrier data
  PROVIDER_PORTAL // Provider's own website/portal
  PHONE_CALL      // Phone verification
  CROWDSOURCE     // User submission
  AUTOMATED       // System-generated
}

enum VerificationType {
  PLAN_ACCEPTANCE     // Verifying plan acceptance
  PROVIDER_INFO       // Verifying provider details
  CONTACT_INFO        // Verifying contact information
  STATUS_CHANGE       // Provider status change
  NEW_PLAN            // New plan added
}

