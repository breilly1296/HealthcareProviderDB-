<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Healthcare Providers</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 0;
    }

    header h1 {
      font-size: 1.8rem;
      color: #2c5282;
      margin-bottom: 8px;
    }

    header p {
      color: #718096;
      font-size: 1.1rem;
    }

    .search-form {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 1.1rem;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }

    input, select {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: #fff;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #4299e1;
    }

    .insurance-row {
      display: flex;
      gap: 12px;
    }

    .insurance-row input {
      flex: 2;
    }

    .insurance-row select {
      flex: 1;
    }

    .btn {
      width: 100%;
      padding: 18px;
      font-size: 1.2rem;
      font-weight: 600;
      color: white;
      background: #4299e1;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #3182ce;
    }

    .btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }

    .results {
      margin-top: 24px;
    }

    .results-header {
      font-size: 1.2rem;
      color: #4a5568;
      margin-bottom: 16px;
    }

    .provider-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .provider-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .provider-card:active {
      transform: translateY(0);
    }

    .provider-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .provider-specialty {
      font-size: 0.95rem;
      color: #4299e1;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .provider-info {
      color: #718096;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .provider-info a {
      color: #4299e1;
      text-decoration: none;
    }

    .verification-badge {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .verified {
      background: #c6f6d5;
      color: #276749;
    }

    .unverified {
      background: #feebc8;
      color: #c05621;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
      font-size: 1.1rem;
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #e2e8f0;
      border-top-color: #4299e1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-results {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .no-results p {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .modal h2 {
      font-size: 1.4rem;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .modal p {
      color: #718096;
      font-size: 1.1rem;
      margin-bottom: 24px;
    }

    .modal-question {
      font-size: 1.2rem;
      color: #4a5568;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-btn {
      flex: 1;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .modal-btn:active {
      transform: scale(0.98);
    }

    .btn-yes {
      background: #48bb78;
      color: white;
    }

    .btn-no {
      background: #fc8181;
      color: white;
    }

    .btn-skip {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-close {
      background: #e2e8f0;
      color: #4a5568;
      margin-top: 16px;
      width: 100%;
    }

    .success-message {
      color: #276749;
      font-size: 1.2rem;
      padding: 20px 0;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .insurance-row {
        flex-direction: column;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .modal {
        padding: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Find Healthcare Providers</h1>
      <p>Search for specialists who accept your insurance</p>
    </header>

    <form class="search-form" id="searchForm">
      <div class="form-group">
        <label for="insurance">Your Insurance</label>
        <div class="insurance-row">
          <input
            type="text"
            id="insurance"
            placeholder="e.g., Blue Cross, Aetna, United"
            autocomplete="off"
          >
          <select id="planType">
            <option value="">Plan Type</option>
            <option value="PPO">PPO</option>
            <option value="HMO">HMO</option>
            <option value="EPO">EPO</option>
            <option value="POS">POS</option>
            <option value="Medicare">Medicare</option>
            <option value="Medicaid">Medicaid</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="zipCode">ZIP Code</label>
        <input
          type="text"
          id="zipCode"
          placeholder="Enter your ZIP code"
          pattern="[0-9]{5}"
          maxlength="5"
          inputmode="numeric"
        >
      </div>

      <div class="form-group">
        <label for="specialty">Specialty</label>
        <select id="specialty" required>
          <option value="">Select a specialty</option>
          <option value="endocrinology">Endocrinology</option>
          <option value="rheumatology">Rheumatology</option>
          <option value="orthopedics">Orthopedics</option>
          <option value="internal_medicine">Internal Medicine</option>
          <option value="family_medicine">Family Medicine</option>
          <option value="geriatrics">Geriatrics</option>
        </select>
      </div>

      <button type="submit" class="btn" id="searchBtn">
        Search Providers
      </button>
    </form>

    <div id="results"></div>
  </div>

  <!-- Verification Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div id="modalContent">
        <!-- Content injected by JS -->
      </div>
    </div>
  </div>

  <script>
    // API base URL - adjust for your environment
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : '/api';

    // State
    let selectedProvider = null;
    let currentStep = 'visited'; // 'visited' | 'insurance' | 'thanks'

    // DOM Elements
    const searchForm = document.getElementById('searchForm');
    const resultsDiv = document.getElementById('results');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');

    // Search form submission
    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const zipCode = document.getElementById('zipCode').value.trim();
      const specialty = document.getElementById('specialty').value;
      const insurance = document.getElementById('insurance').value.trim();
      const planType = document.getElementById('planType').value;

      if (!specialty) {
        alert('Please select a specialty');
        return;
      }

      await searchProviders({ zipCode, specialty, insurance, planType });
    });

    // Search providers
    async function searchProviders({ zipCode, specialty, insurance, planType }) {
      const searchBtn = document.getElementById('searchBtn');
      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';

      resultsDiv.innerHTML = `
        <div class="loading">
          <span class="spinner"></span>
          Finding providers near you...
        </div>
      `;

      try {
        // Build query params
        const params = new URLSearchParams();
        if (zipCode) params.append('zip', zipCode);
        if (specialty) params.append('specialty', specialty);
        params.append('limit', '20');

        const response = await fetch(`${API_BASE}/providers?${params}`);

        if (!response.ok) {
          throw new Error('Failed to fetch providers');
        }

        const data = await response.json();
        displayResults(data.providers || data, insurance, planType);

      } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = `
          <div class="error">
            Unable to search providers. Please make sure the API server is running.
          </div>
          <div class="no-results">
            <p>Start the server with: <code>npm run dev</code></p>
          </div>
        `;
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Search Providers';
      }
    }

    // Display search results
    function displayResults(providers, insurance, planType) {
      if (!providers || providers.length === 0) {
        resultsDiv.innerHTML = `
          <div class="no-results">
            <p>No providers found</p>
            <p>Try a different ZIP code or specialty</p>
          </div>
        `;
        return;
      }

      const userInsurance = [insurance, planType].filter(Boolean).join(' ');

      resultsDiv.innerHTML = `
        <div class="results-header">
          Found ${providers.length} provider${providers.length !== 1 ? 's' : ''}
        </div>
        ${providers.map(provider => createProviderCard(provider, userInsurance)).join('')}
      `;

      // Add click handlers
      document.querySelectorAll('.provider-card').forEach(card => {
        card.addEventListener('click', () => {
          const npi = card.dataset.npi;
          const provider = providers.find(p => p.npi === npi);
          if (provider) {
            openVerificationModal(provider, userInsurance);
          }
        });
      });
    }

    // Create provider card HTML
    function createProviderCard(provider, userInsurance) {
      const name = formatProviderName(provider);
      const address = formatAddress(provider);
      const phone = provider.phone || provider.practicePhone || 'No phone listed';
      const verificationCount = provider.verificationCount || 0;

      const verificationBadge = verificationCount > 0
        ? `<span class="verification-badge verified">Verified by ${verificationCount} patient${verificationCount !== 1 ? 's' : ''}</span>`
        : `<span class="verification-badge unverified">Unverified - be the first!</span>`;

      return `
        <div class="provider-card" data-npi="${provider.npi}">
          <div class="provider-name">${name}</div>
          <div class="provider-specialty">${formatSpecialty(provider.specialty)}</div>
          <div class="provider-info">${address}</div>
          <div class="provider-info">
            <a href="tel:${phone.replace(/\D/g, '')}">${formatPhone(phone)}</a>
          </div>
          ${verificationBadge}
        </div>
      `;
    }

    // Format provider name
    function formatProviderName(provider) {
      if (provider.organizationName) {
        return provider.organizationName;
      }
      const parts = [
        provider.firstName,
        provider.middleName,
        provider.lastName,
        provider.credential
      ].filter(Boolean);
      return parts.join(' ') || 'Unknown Provider';
    }

    // Format address
    function formatAddress(provider) {
      const parts = [
        provider.practiceAddress1 || provider.address1,
        provider.practiceCity || provider.city,
        provider.practiceState || provider.state,
        provider.practiceZip || provider.zip
      ].filter(Boolean);
      return parts.join(', ') || 'Address not available';
    }

    // Format phone number
    function formatPhone(phone) {
      if (!phone) return 'No phone';
      const digits = phone.replace(/\D/g, '');
      if (digits.length === 10) {
        return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      }
      return phone;
    }

    // Format specialty
    function formatSpecialty(specialty) {
      if (!specialty) return 'Specialist';
      return specialty
        .replace(/_/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    // Open verification modal
    function openVerificationModal(provider, userInsurance) {
      selectedProvider = provider;
      currentStep = 'visited';
      updateModalContent(userInsurance);
      modal.classList.add('active');
    }

    // Close modal
    function closeModal() {
      modal.classList.remove('active');
      selectedProvider = null;
      currentStep = 'visited';
    }

    // Update modal content based on step
    function updateModalContent(userInsurance = '') {
      const name = formatProviderName(selectedProvider);

      if (currentStep === 'visited') {
        modalContent.innerHTML = `
          <h2>${name}</h2>
          <p class="modal-question">Have you visited this doctor?</p>
          <div class="modal-buttons">
            <button class="modal-btn btn-yes" onclick="handleVisited(true, '${userInsurance}')">
              Yes
            </button>
            <button class="modal-btn btn-skip" onclick="closeModal()">
              Not yet
            </button>
          </div>
        `;
      } else if (currentStep === 'insurance') {
        modalContent.innerHTML = `
          <h2>${name}</h2>
          <p class="modal-question">Did they accept your insurance?</p>
          <div class="modal-buttons">
            <button class="modal-btn btn-yes" onclick="handleInsurance(true)">
              Yes
            </button>
            <button class="modal-btn btn-no" onclick="handleInsurance(false)">
              No
            </button>
          </div>
        `;
      } else if (currentStep === 'thanks') {
        modalContent.innerHTML = `
          <div class="success-message">
            Thank you for your feedback!
          </div>
          <p>Your verification helps other patients find the right care.</p>
          <button class="modal-btn btn-close" onclick="closeModal()">
            Close
          </button>
        `;
      }
    }

    // Handle "visited" response
    function handleVisited(visited, userInsurance) {
      if (visited) {
        currentStep = 'insurance';
        updateModalContent(userInsurance);
      } else {
        closeModal();
      }
    }

    // Handle insurance acceptance response
    async function handleInsurance(accepted) {
      // Submit verification to API
      try {
        const response = await fetch(`${API_BASE}/providers/${selectedProvider.npi}/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            acceptsInsurance: accepted,
            submittedBy: 'anonymous'
          })
        });

        // Even if API fails, show thanks (we'll store locally as backup)
        if (!response.ok) {
          console.log('API not available, verification noted locally');
        }
      } catch (error) {
        console.log('Could not submit verification to API:', error);
      }

      currentStep = 'thanks';
      updateModalContent();
    }

    // Close modal on overlay click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        closeModal();
      }
    });

    // Only allow numbers in ZIP code field
    document.getElementById('zipCode').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
    });
  </script>
</body>
</html>
